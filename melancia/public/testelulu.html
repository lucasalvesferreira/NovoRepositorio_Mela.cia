<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" href="./assets/icons/melan2.ico" type="image/x-icon">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
  <script src="http://www.chartjs.org/dist/2.7.1/Chart.js"></script>
  <script src="http://www.chartjs.org/samples/latest/utils.js"></script>
  <link rel="stylesheet" href="testeuser.css">
  <title>Melan.cia </title>
</head>

<body>



  <div class="header">
    <a href="./index.html">
      <h1><span class="mel">Melan</span><span class="ciaa">.cia</span></h1>
    </a>
    <nav class="stroke">
      <ul>
        <li><a href="#">Inicio</a></li>
        <li><a href="#">Sobre nós</a></li>
        <li><a href="#">Calculadora</a></li>
        <li><a href="cadastro.html">Login / Cadastro</a></li>
      </ul>
    </nav>
    </section>
  </div>

  <div class="container">
    <div class="bar">
      <h2>Bem vindo(a) Batatinha</h2>
      <p>Aqui ficam os seus gráficos com os dados de suas planta
        es e algumas informações sobre cada uma delas!</p>
    </div>
    <section class="section1">
      <h3>Primeiro quadrante: <label id='average'>0.00</label></h3>
    </section>
    <section class="section2" style="width:70%;">
      <canvas id="chart">

      </canvas>
      <section>

  </div>

  <div class="icons">
    <p>
      Melan.cia Copyright © 2021 grupo-5 Company All rights reserved.
    </p>
  </div>

</body>

</html>

<script>

  var context = document.getElementById("chart").getContext("2d");
  context.canvas.width = 1000;
  context.canvas.height = 300;

  var configuration = {
    type: 'line',
    data: {
      datasets: [{
        label: "Temperature x Time",
        type: 'line',
      }]
    },
    options: {
      scales: {
        xAxes: [{
          //type: 'value',
          distribution: 'series',
          ticks: {
            beginAtZero: true
          }
        }],
        yAxes: [{
          scaleLabel: {
            display: true,
            labelString: 'Temperature'
          },
          ticks: {
            beginAtZero: true
          }
        }]
      },
      animation: {
        duration: 0
      }
    }
  };

  var chart = new Chart(context, configuration);

  //Função para obter os dados de temperatura do server
  //Seria mais interessante fazer isso com WebSocket, porém para fins academicos, os dados serão atualizados via HTTP

  //Esse atributo dentro do contexto serve para saber qual foi o último índice processado, assim eliminado os outros elementos na
  //hora de montar/atualizar o gráfico
  this.lastIndexTemp = 0;
  this.time = 0;

  function get_data() {

    var http = new XMLHttpRequest();
    http.open('GET', 'http://localhost:3000/api/temperature', false);
    http.send(null);

    var obj = JSON.parse(http.responseText);

    if (obj.data.length == 0) {
      return;
    }

    var _lastIndexTemp = this.lastIndexTemp;
    this.lastIndexTemp = obj.data.length;
    listTemp = obj.data.slice(_lastIndexTemp);

    listTemp.forEach(data => {
      //Máximo de 60 itens exibidos no gráfico
      if (chart.data.labels.length == 10 && chart.data.datasets[0].data.length == 10) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
      }

      chart.data.labels.push(this.time++);
      chart.data.datasets[0].data.push(parseFloat(data));
      chart.update();
    });

    document.getElementById('average').textContent = obj.average
  }

  get_data();

  setInterval(() => {
    get_data();
  }, 1000);

</script>